
{% extends "base.html" %}

{% block title %}Consultas e Receitas - Guarda Theo{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Consultas Médicas e Receitas</h1>
    <button class="btn btn-primary" onclick="abrirModalConsulta()">+ Nova Consulta</button>
</div>

<div class="consultas-container">
    <!-- Calendário de Consultas -->
    <div class="calendario-consultas">
        <div class="calendar-header">
            <button id="btn-prev-month-consultas" class="btn btn-nav">‹</button>
            <h3 id="calendar-title-consultas"></h3>
            <button id="btn-next-month-consultas" class="btn btn-nav">›</button>
        </div>
        
        <div class="calendar-consultas">
            <div class="calendar-header-days">
                <div class="day-header">Dom</div>
                <div class="day-header">Seg</div>
                <div class="day-header">Ter</div>
                <div class="day-header">Qua</div>
                <div class="day-header">Qui</div>
                <div class="day-header">Sex</div>
                <div class="day-header">Sáb</div>
            </div>
            <div class="calendar-days" id="calendar-days-consultas">
                <!-- Dias serão carregados aqui -->
            </div>
        </div>
    </div>
    
    <div class="consultas-grid" id="consultas-grid">
        <!-- Consultas serão carregadas aqui -->
    </div>
</div>

<!-- Modal simplificado -->
<div id="modal-consulta" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nova Consulta</h3>
            <span class="close" onclick="fecharModalConsulta()">&times;</span>
        </div>
        <form id="consulta-form">
            <div class="form-group">
                <label for="data_consulta">Data</label>
                <input type="date" id="data_consulta" name="data_consulta" required>
            </div>
            <div class="form-group">
                <label for="medico">Médico/Especialista</label>
                <input type="text" id="medico" name="medico" required>
            </div>
            <div class="form-group">
                <label for="especialidade">Especialidade</label>
                <input type="text" id="especialidade" name="especialidade">
            </div>
            <div class="form-group">
                <label for="motivo">Motivo da Consulta</label>
                <textarea id="motivo" name="motivo" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="observacoes_consulta">Observações/Receita</label>
                <textarea id="observacoes_consulta" name="observacoes_consulta" rows="4"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Salvar</button>
                <button type="button" class="btn btn-secondary" onclick="fecharModalConsulta()">Cancelar</button>
            </div>
        </form>
    </div>
</div>

<script>
let consultas = [];
let currentMonthConsultas = new Date().getMonth();
let currentYearConsultas = new Date().getFullYear();

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('data_consulta').value = new Date().toISOString().split('T')[0];
    carregarConsultas();
    setupCalendarioConsultas();
    
    document.getElementById('consulta-form').addEventListener('submit', function(e) {
        e.preventDefault();
        salvarConsulta();
    });
});

function setupCalendarioConsultas() {
    document.getElementById('btn-prev-month-consultas').addEventListener('click', () => {
        currentMonthConsultas--;
        if (currentMonthConsultas < 0) {
            currentMonthConsultas = 11;
            currentYearConsultas--;
        }
        renderCalendarioConsultas();
    });

    document.getElementById('btn-next-month-consultas').addEventListener('click', () => {
        currentMonthConsultas++;
        if (currentMonthConsultas > 11) {
            currentMonthConsultas = 0;
            currentYearConsultas++;
        }
        renderCalendarioConsultas();
    });
    
    renderCalendarioConsultas();
}

function renderCalendarioConsultas() {
    const monthNames = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
    ];

    document.getElementById('calendar-title-consultas').textContent = 
        `${monthNames[currentMonthConsultas]} ${currentYearConsultas}`;

    const firstDay = new Date(currentYearConsultas, currentMonthConsultas, 1).getDay();
    const daysInMonth = new Date(currentYearConsultas, currentMonthConsultas + 1, 0).getDate();
    const calendarDays = document.getElementById('calendar-days-consultas');

    calendarDays.innerHTML = '';

    // Add empty cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day other-month';
        calendarDays.appendChild(dayElement);
    }

    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';

        const dateStr = `${currentYearConsultas}-${String(currentMonthConsultas + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // Check if there's a consultation on this day
        const consultasDoDia = consultas.filter(c => c.data_consulta === dateStr);
        
        let consultasInfo = '';
        if (consultasDoDia.length > 0) {
            dayElement.classList.add('has-consulta');
            consultasInfo = `<div class="consulta-marker">${consultasDoDia.length} consulta(s)</div>`;
        }

        dayElement.innerHTML = `
            <div class="day-number">${day}</div>
            ${consultasInfo}
        `;

        calendarDays.appendChild(dayElement);
    }
}

function carregarConsultas() {
    fetch('/api/consultas')
        .then(response => response.json())
        .then(data => {
            consultas = data.sort((a, b) => new Date(b.data_consulta) - new Date(a.data_consulta));
            renderizarConsultas();
        });
}

function renderizarConsultas() {
    const grid = document.getElementById('consultas-grid');
    
    if (consultas.length === 0) {
        grid.innerHTML = '<p class="empty-state">Nenhuma consulta registrada.</p>';
        return;
    }
    
    grid.innerHTML = consultas.map(consulta => `
        <div class="consulta-card">
            <div class="consulta-date">${formatarData(consulta.data_consulta)}</div>
            <h3>${consulta.medico}</h3>
            <p class="especialidade">${consulta.especialidade || 'Clínico Geral'}</p>
            ${consulta.motivo ? `<p><strong>Motivo:</strong> ${consulta.motivo}</p>` : ''}
            ${consulta.observacoes_consulta ? `<div class="observacoes">${consulta.observacoes_consulta}</div>` : ''}
        </div>
    `).join('');
    
    // Atualizar calendário após carregar consultas
    renderCalendarioConsultas();
}

function abrirModalConsulta() {
    document.getElementById('modal-consulta').style.display = 'block';
}

function fecharModalConsulta() {
    document.getElementById('modal-consulta').style.display = 'none';
    document.getElementById('consulta-form').reset();
    document.getElementById('data_consulta').value = new Date().toISOString().split('T')[0];
}

function salvarConsulta() {
    const formData = new FormData(document.getElementById('consulta-form'));
    const data = Object.fromEntries(formData);
    
    fetch('/api/consultas/salvar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.sucesso) {
            fecharModalConsulta();
            carregarConsultas();
        } else {
            alert('Erro ao salvar: ' + result.erro);
        }
    });
}

function formatarData(data) {
    return new Date(data).toLocaleDateString('pt-BR');
}
</script>

<style>
.consulta-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 20px;
    border-left: 4px solid #28a745;
}

.consulta-date {
    color: #28a745;
    font-weight: 600;
    margin-bottom: 10px;
}

.especialidade {
    color: #666;
    font-style: italic;
    margin-bottom: 10px;
}

.calendario-consultas {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 30px;
}

.calendar-consultas {
    background: white;
    border-radius: 10px;
    overflow: hidden;
}

.calendar-consultas .calendar-day {
    min-height: 60px;
    border: 1px solid #ddd;
    padding: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    position: relative;
}

.calendar-consultas .calendar-day:hover {
    background-color: #f8f9fa;
}

.calendar-consultas .calendar-day.has-consulta {
    background-color: #e3f2fd;
    border-color: #2196f3;
}

.consulta-marker {
    font-size: 0.7rem;
    color: #2196f3;
    font-weight: 600;
    margin-top: 2px;
}

.observacoes {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 5px;
    margin-top: 10px;
    white-space: pre-wrap;
}
</style>
{% endblock %}
